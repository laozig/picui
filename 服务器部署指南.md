# PicUI服务器部署指南

本文档提供在Ubuntu和Windows服务器上部署PicUI图床服务的详细步骤和最佳实践。

## 目录

- [Ubuntu服务器部署](#ubuntu服务器部署)
- [Windows服务器部署](#windows服务器部署)
- [Nginx反向代理配置](#nginx反向代理配置)
- [SSL证书配置](#ssl证书配置)
- [数据备份](#数据备份)
- [性能优化](#性能优化)

## Ubuntu服务器部署

### 安装依赖

```bash
# 更新系统包
sudo apt update
sudo apt upgrade -y

# 安装Python和相关工具
sudo apt install -y python3 python3-pip python3-venv git
```

### 拉取代码并安装

```bash
# 创建应用目录
mkdir -p /opt/picui
cd /opt/picui

# 克隆代码（如果使用Git）
git clone https://github.com/laozig/picui.git .
# 或者手动上传代码到服务器

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 配置服务

1. 创建systemd服务配置文件：

```bash
sudo nano /etc/systemd/system/picui.service
```

2. 添加以下内容：

```ini
[Unit]
Description=PicUI Image Hosting Service
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/opt/picui
ExecStart=/opt/picui/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10
Environment="PYTHONPATH=/opt/picui"
Environment="UPLOAD_DIR=/opt/picui/uploads"
Environment="MAX_FILE_SIZE=20971520"
# 如果需要使用外部数据库，取消注释下一行并修改
# Environment="DATABASE_URL=postgresql://user:password@localhost:5432/picuidb"

[Install]
WantedBy=multi-user.target
```

3. 修改目录权限：

```bash
sudo mkdir -p /opt/picui/uploads
sudo chown -R www-data:www-data /opt/picui
```

4. 启用并启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable picui
sudo systemctl start picui
```

5. 查看服务状态：

```bash
sudo systemctl status picui
```

### 使用Screen运行（替代方法）

如果不想设置systemd服务，可以使用Screen在后台运行：

```bash
# 安装screen
sudo apt install -y screen

# 创建新screen会话
screen -S picui

# 激活虚拟环境
source venv/bin/activate

# 设置环境变量
export MAX_FILE_SIZE=20971520
export UPLOAD_DIR=/opt/picui/uploads

# 启动应用
python -m uvicorn main:app --host 0.0.0.0 --port 8000

# 按 Ctrl+A 然后按 D 可以分离screen会话
# 使用以下命令可以重新连接到会话
# screen -r picui
```

## Windows服务器部署

### 安装Python

1. 下载并安装Python 3.8+，从[Python官网](https://www.python.org/downloads/windows/)
2. 安装时勾选"Add Python to PATH"选项

### 拉取代码并安装

```powershell
# 创建应用目录
mkdir C:\picui
cd C:\picui

# 如果使用Git，安装Git并克隆代码
# git clone https://github.com/你的用户名/picui.git .
# 或者手动复制代码到服务器

# 创建虚拟环境
python -m venv venv
.\venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 创建上传目录
mkdir uploads
```

### 使用NSSM设置Windows服务

1. 下载[NSSM](http://nssm.cc/download)并解压
2. 将nssm.exe复制到系统PATH中的目录（如C:\Windows\System32）
3. 创建一个启动脚本(start_picui.bat)：

```batch
@echo off
cd C:\picui
call venv\Scripts\activate
set UPLOAD_DIR=C:\picui\uploads
set MAX_FILE_SIZE=20971520
uvicorn main:app --host 0.0.0.0 --port 8000
```

4. 使用NSSM创建服务：

```powershell
# 打开管理员命令提示符并运行
nssm install PicUI

# 在弹出窗口中配置以下内容：
# Path: C:\picui\start_picui.bat
# Startup directory: C:\picui
# 在Details标签下设置服务名称和描述
# 在Environment标签下添加必要的环境变量:
# UPLOAD_DIR=C:\picui\uploads
# MAX_FILE_SIZE=20971520
```

5. 启动服务：

```powershell
nssm start PicUI
```

### 使用PowerShell在后台运行（替代方法）

如果不想设置Windows服务，可以使用PowerShell在后台运行：

```powershell
$env:UPLOAD_DIR = "C:\picui\uploads"
$env:MAX_FILE_SIZE = "20971520"
Start-Process -NoNewWindow -FilePath "C:\picui\venv\Scripts\python.exe" -ArgumentList "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000" -WorkingDirectory "C:\picui"
```

## Nginx反向代理配置

在生产环境中，建议使用Nginx作为前端反向代理服务器。

### Ubuntu上安装Nginx

```bash
sudo apt install -y nginx
```

### 配置Nginx反向代理

1. 创建Nginx配置文件：

```bash
sudo nano /etc/nginx/sites-available/picui
```

2. 添加以下内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名

    client_max_body_size 25M;  # 允许上传的最大文件大小（比应用限制稍大）

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件缓存设置
    location /static/ {
        alias /opt/picui/static/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }

    # 上传的图片缓存设置
    location /uploads/ {
        alias /opt/picui/uploads/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
}
```

3. 启用站点并重启Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/picui /etc/nginx/sites-enabled/
sudo nginx -t  # 检查配置是否有误
sudo systemctl restart nginx
```

## SSL证书配置

使用Let's Encrypt免费SSL证书保护您的网站：

### 安装Certbot

```bash
sudo apt install -y certbot python3-certbot-nginx
```

### 获取并安装证书

```bash
sudo certbot --nginx -d your-domain.com
```

按照提示完成配置。Certbot会自动修改Nginx配置以启用HTTPS。

### 自动续期

Certbot会自动添加一个定时任务来续期证书。您可以通过以下命令测试续期过程：

```bash
sudo certbot renew --dry-run
```

## 数据备份

定期备份您的数据是很重要的。以下是一个简单的备份脚本示例：

### 创建备份脚本

```bash
sudo nano /opt/picui/backup.sh
```

添加以下内容：

```bash
#!/bin/bash

# 设置变量
BACKUP_DIR="/var/backups/picui"
DATE=$(date +%Y-%m-%d)
APP_DIR="/opt/picui"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp $APP_DIR/picui.db $BACKUP_DIR/picui-$DATE.db

# 备份上传的图片
tar -czf $BACKUP_DIR/uploads-$DATE.tar.gz $APP_DIR/uploads

# 删除30天前的备份
find $BACKUP_DIR -name "*.db" -type f -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -type f -mtime +30 -delete

echo "备份完成: $(date)"
```

### 设置执行权限

```bash
sudo chmod +x /opt/picui/backup.sh
```

### 添加定时任务

```bash
sudo crontab -e
```

添加以下行以每天凌晨3点执行备份：

```
0 3 * * * /opt/picui/backup.sh >> /var/log/picui-backup.log 2>&1
```

## 性能优化

### 增加工作进程

对于高流量网站，可以使用多个工作进程：

1. 修改systemd服务文件：

```bash
sudo nano /etc/systemd/system/picui.service
```

2. 更改ExecStart行：

```ini
ExecStart=/opt/picui/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

3. 重新加载并重启服务：

```bash
sudo systemctl daemon-reload
sudo systemctl restart picui
```

### 使用Gunicorn

对于生产环境，可以考虑使用Gunicorn作为ASGI服务器：

1. 安装Gunicorn：

```bash
source venv/bin/activate
pip install gunicorn uvicorn[standard]
```

2. 创建Gunicorn配置文件：

```bash
sudo nano /opt/picui/gunicorn_conf.py
```

添加以下内容：

```python
import multiprocessing

# 工作进程数量（通常设置为CPU核心数的2-4倍）
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "uvicorn.workers.UvicornWorker"
bind = "0.0.0.0:8000"

# 超时设置
timeout = 120
keepalive = 5

# 日志设置
errorlog = "/var/log/picui/error.log"
accesslog = "/var/log/picui/access.log"
loglevel = "info"
```

3. 更新systemd服务文件：

```ini
ExecStart=/opt/picui/venv/bin/gunicorn -c /opt/picui/gunicorn_conf.py main:app
```

### 监控和日志

设置适当的监控和日志记录：

1. 创建日志目录：

```bash
sudo mkdir -p /var/log/picui
sudo chown www-data:www-data /var/log/picui
```

2. 配置日志轮转：

```bash
sudo nano /etc/logrotate.d/picui
```

添加以下内容：

```
/var/log/picui/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload picui >/dev/null 2>&1 || true
    endscript
}
```

## 故障排查

### 服务无法启动

1. 检查日志：

```bash
sudo journalctl -u picui.service -n 50
```

2. 检查权限：

```bash
sudo chown -R www-data:www-data /opt/picui
```

3. 手动尝试启动应用以查看错误：

```bash
cd /opt/picui
source venv/bin/activate
python -m uvicorn main:app --host 0.0.0.0 --port 8000
```

### 无法上传图片

1. 检查上传目录权限：

```bash
sudo chown -R www-data:www-data /opt/picui/uploads
sudo chmod 755 /opt/picui/uploads
```

2. 检查Nginx客户端上传大小限制：

```bash
sudo nano /etc/nginx/nginx.conf
```

确保包含：

```nginx
http {
    # ... 其他配置 ...
    client_max_body_size 25M;
}
```

### 其他常见问题

- **数据库锁定**：如果SQLite数据库被锁定，可能需要重启应用
- **端口被占用**：检查端口是否已被其他应用使用
- **内存不足**：检查服务器资源使用情况，考虑增加交换空间

如有其他问题，请查看应用日志和系统日志以获取更多信息。 