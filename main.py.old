#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
PicUI图床服务 - 入口文件
提供快速高效的图片上传托管服务
"""
import os
import uvicorn
import asyncio
import multiprocessing
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

# 获取环境变量中的配置
PORT = int(os.getenv("PORT", 8000))
HOST = os.getenv("HOST", "0.0.0.0")
WORKERS = int(os.getenv("WORKERS", min(multiprocessing.cpu_count() + 1, 8)))
RELOAD = os.getenv("RELOAD", "false").lower() == "true"
LOG_LEVEL = os.getenv("LOG_LEVEL", "info").lower()

def main():
    """
    主入口函数
    使用uvicorn启动FastAPI应用，根据CPU核心数自动配置工作进程
    """
    print(f"正在启动 PicUI图床服务...")
    print(f"工作进程数: {WORKERS}")
    print(f"监听地址: {HOST}:{PORT}")
    
    # 启动服务器
    uvicorn.run(
        "src.app:app", 
        host=HOST, 
        port=PORT, 
        reload=RELOAD,
        workers=WORKERS if not RELOAD else 1,  # reload模式下只能使用1个worker
        log_level=LOG_LEVEL
    )

if __name__ == "__main__":
    main() 