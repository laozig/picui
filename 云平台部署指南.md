# PicUI云平台部署指南

本文档提供在不同云平台上部署PicUI图床服务的详细说明，包括文件持久化配置和环境变量设置。

## 环境变量配置

PicUI支持以下环境变量：

- `PORT`: 应用监听端口（默认: 8000）
- `HOST`: 应用监听地址（默认: 0.0.0.0）
- `BASE_URL`: 应用基础URL（默认: http://localhost:PORT）
- `UPLOAD_DIR`: 上传文件存储目录（默认: uploads）
- `MAX_FILE_SIZE`: 最大文件大小（字节，默认: 20971520，即20MB）
- `DATABASE_URL`: 数据库URL（默认: sqlite:///./picui.db）

## Docker 部署

使用以下命令构建并运行Docker容器：

```bash
# 构建镜像
docker build -t picui .

# 运行容器
docker run -d -p 8000:8000 -v $(pwd)/uploads:/app/uploads --name picui picui
```

## Railway 部署

[Railway](https://railway.app/) 是一个现代化的云平台，可以轻松部署PicUI。

1. 安装 Railway CLI (可选)：
```bash
npm install -g @railway/cli
```

2. 登录 Railway：
```bash
railway login
```

3. 初始化项目：
```bash
railway init
```

4. 部署到 Railway：
```bash
railway up
```

5. 配置持久存储：

在 Railway 控制台 -> 项目设置 -> 挂载点，添加新的持久卷：
- 卷名称：uploads
- 路径：/app/uploads

6. 设置环境变量（可选）：
   - 在项目设置 -> 变量中添加所需的环境变量
   - 特别是设置 `BASE_URL` 为您的应用URL

## Render 部署

[Render](https://render.com/) 提供免费的Web服务，适合部署PicUI。

1. 登录 [Render Dashboard](https://dashboard.render.com/)
2. 点击 "New Web Service"
3. 选择从 GitHub 导入项目
4. 配置以下设置：
   - 服务名称：picui（或您喜欢的名称）
   - 运行时环境：Docker
   - 分支：main
   - 构建命令：不需要（使用Dockerfile）
   - 启动命令：不需要（使用Dockerfile）
   
5. 配置持久存储：
   - 在部署后，进入服务设置
   - 添加磁盘：
     - 名称：uploads
     - 挂载路径：/app/uploads
     - 大小：至少1GB

6. 设置环境变量（可选）：
   - 在服务设置 -> 环境变量中添加所需的环境变量
   - 建议设置 `BASE_URL` 为您的Render应用URL

## Heroku 部署

[Heroku](https://www.heroku.com/) 也是部署PicUI的好选择。

1. 安装 Heroku CLI：
```bash
# 根据您的操作系统安装
# https://devcenter.heroku.com/articles/heroku-cli
```

2. 登录 Heroku：
```bash
heroku login
```

3. 创建应用：
```bash
heroku create picui-app
```

4. 添加 Heroku Postgres 插件（可选）：
```bash
heroku addons:create heroku-postgresql:hobby-dev
```

5. 设置环境变量：
```bash
heroku config:set BASE_URL=https://您的应用名称.herokuapp.com
```

6. 部署应用：
```bash
git push heroku main
```

7. **注意**：Heroku使用临时文件系统，上传的文件会在应用重启后丢失。建议配置外部存储服务如AWS S3或类似服务。

## 数据库配置

默认使用SQLite数据库，存储在应用目录中。对于生产环境，建议使用外部数据库：

1. 在云平台上创建PostgreSQL或MySQL数据库
2. 设置环境变量 `DATABASE_URL` 为数据库连接字符串，如：
   - PostgreSQL: `postgresql://user:password@hostname:port/dbname`
   - MySQL: `mysql://user:password@hostname:port/dbname`

## 确保文件持久化

为了确保上传的文件不会在应用重启后丢失，请务必按照上面指南配置持久存储。对于不支持持久卷的平台，考虑使用以下方案：

1. 使用云存储服务（如AWS S3、Google Cloud Storage等）
2. 使用数据库存储图片（适用于小型应用）
3. 使用专门的对象存储服务

## 安全注意事项

1. 在生产环境中，建议使用HTTPS
2. 考虑添加身份验证和授权机制
3. 设置适当的CORS策略
4. 定期备份数据库和上传的文件
5. 考虑设置上传速率限制，防止滥用

## 故障排查

1. 应用无法启动：
   - 检查环境变量配置和日志
   - 确认端口设置正确且未被占用

2. 上传失败：
   - 检查持久卷挂载是否正确
   - 验证上传目录权限
   - 检查文件大小是否超过限制

3. 文件不可访问：
   - 检查文件权限和路径配置
   - 确认静态文件服务配置正确

4. 数据库连接问题：
   - 验证数据库连接字符串格式
   - 确保数据库服务可访问

## 性能优化

对于高流量应用，可以考虑以下优化：

1. 使用CDN分发图片
2. 配置适当的缓存策略
3. 考虑使用负载均衡
4. 优化图片存储和检索逻辑 